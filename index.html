<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver/Admin Prototype (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .checked-in { background-color: #d1fae5; border-left: 4px solid #10b981; }
        .undo-button { background-color: #f59e0b; }
        .undo-button:hover { background-color: #d97706; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; }
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .feedback-message { padding: 10px; margin-top: 10px; border-radius: 5px; font-size: 0.875rem; }
        .feedback-success { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .feedback-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .hidden { display: none; }
        .loading-indicator { font-style: italic; color: #6b7280; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .add-button {
            background-color: #10b981; /* green-500 */
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-button:hover {
            background-color: #059669; /* green-600 */
        }
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
        }
        .sortable-header:hover {
            background-color: #f3f4f6;
        }
        .sortable-header::after {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #9ca3af;
            opacity: 0.5;
        }
        .sortable-header.asc::after {
            border-bottom: 4px solid #4f46e5;
            opacity: 1;
        }
        .sortable-header.desc::after {
            border-top: 4px solid #4f46e5;
            border-bottom: none;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">

        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button id="tab-driver" onclick="switchView('driver')" class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm" aria-current="page">
                    Driver Check-in
                </button>
                <button id="tab-admin" onclick="switchView('admin')" class="text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Admin Dashboard
                </button>
            </nav>
        </div>

        <div id="driver-view">
             <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Driver Check-in Portal</h1>
            <div class="mb-6">
                <label for="bus-select" class="block text-sm font-medium text-gray-700 mb-2">Select Bus:</label>
                <select id="bus-select" class="block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                     <option value="" disabled selected>Loading buses...</option>
                </select>
            </div>
            <div class="mb-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Passenger List</h2>
                <div id="passenger-list" class="space-y-3">
                    <p class="text-gray-500 text-center loading-indicator">Select a bus to see the passenger list.</p>
                </div>
            </div>
            <div class="mt-6 p-4 bg-gray-50 rounded-md border border-gray-200">
                <h3 class="text-md font-semibold text-gray-700 mb-2">Summary</h3>
                <p class="text-sm text-gray-600">Total Passengers: <span id="total-passengers" class="font-medium">0</span></p>
                <p class="text-sm text-green-600">Checked In: <span id="checked-in-count" class="font-medium">0</span></p>
                <p class="text-sm text-red-600">Pending: <span id="pending-count" class="font-medium">0</span></p>
            </div>
        </div>

        <div id="admin-view" class="hidden">
            <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">Admin Dashboard</h1>

            <div class="mb-8">
                 <div class="flex items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-700">Manage Buses</h2>
                    <button onclick="openAddBusModal()" class="add-button" title="Add New Bus">
                        <i class="fas fa-plus"></i>
                    </button>
                 </div>
                 <div class="overflow-x-auto">
                     <table class="min-w-full divide-y divide-gray-200">
                         <thead class="bg-gray-50">
                             <tr>
                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Identifier/Route</th>
                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Passengers</th>
                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Checked In</th>
                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                 <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                             </tr>
                         </thead>
                         <tbody id="admin-bus-table-body" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="5" class="text-center p-4 loading-indicator">Loading buses...</td></tr>
                         </tbody>
                     </table>
                 </div>
            </div>

            <div class="mb-8">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center">
                        <h2 class="text-lg font-semibold text-gray-700">Manage Passengers</h2>
                        <button onclick="openAddPassengerModal()" class="add-button" title="Add New Passenger">
                             <i class="fas fa-plus"></i>
                        </button>
                    </div>
                     <button id="toggle-bulk-add-btn" onclick="toggleBulkAddPanel()" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Show Bulk Add
                    </button>
                </div>

                 <div id="bulk-add-panel" class="hidden mb-4 border border-gray-200 p-4 rounded-md bg-gray-50">
                    <h3 class="text-md font-semibold text-gray-700 mb-3">Bulk Add Passengers Form</h3>
                    <p class="text-sm text-gray-600 mb-2">
                        Upload an Excel file (.xlsx) with the following columns:<br>
                        <code class="text-xs bg-white p-1 rounded border border-gray-300">Name, Gender, MobileNumber</code>
                    </p>
                    <p class="text-xs text-gray-500 mb-3">
                        Example: <code class="text-xs bg-white p-1 rounded border border-gray-300">John Doe,Male,555-1234</code>
                    </p>
                    <input type="file" id="excel-file" accept=".xlsx" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-indigo-50 file:text-indigo-700
                        hover:file:bg-indigo-100" />
                    <button id="import-list-button" onclick="handleBulkAddPassengers()" class="mt-3 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Import Excel
                    </button>
                    <div id="bulk-add-feedback" class="mt-3"></div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                         <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="name">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="gender">Gender</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="mobile">Mobile</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="bus">Assigned Bus</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort="status">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admin-passenger-table-body" class="bg-white divide-y divide-gray-200">
                             <tr><td colspan="6" class="text-center p-4 loading-indicator">Loading passengers...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h3 id="modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4">Edit/Add Item</h3>
            <form>
                <input type="hidden" id="edit-item-id">
                <input type="hidden" id="edit-item-type">
                <div id="edit-fields" class="space-y-4">
                    <p class="loading-indicator">Loading form...</p>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 text-sm">Cancel</button>
                    <button type="button" id="modal-save-button" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
      // Import necessary functions from the Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import {
          getFirestore, collection, getDocs, getDoc, doc, addDoc,
          updateDoc, deleteDoc, query, where, writeBatch
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyAhkVH0vOOxWxkan7InqqchjTKX4fko9vg",
        authDomain: "busroute-f8724.firebaseapp.com",
        projectId: "busroute-f8724",
        storageBucket: "busroute-f8724.firebasestorage.app",
        messagingSenderId: "340211513292",
        appId: "1:340211513292:web:20535e2dc4202980e1cf69",
        measurementId: "G-KGFQ6L6RTB"
      };
      // -----------------------------

      // Initialize Firebase
      try {
          const app = initializeApp(firebaseConfig);
          const db = getFirestore(app);
          console.log("Firebase Initialized Successfully.");

          // --- Global variable to cache buses ---
          let cachedBuses = [];

          // --- DOM Elements ---
          const busSelect = document.getElementById('bus-select');
          const passengerListDiv = document.getElementById('passenger-list');
          const totalPassengersSpan = document.getElementById('total-passengers');
          const checkedInCountSpan = document.getElementById('checked-in-count');
          const pendingCountSpan = document.getElementById('pending-count');
          const driverViewDiv = document.getElementById('driver-view');
          const adminViewDiv = document.getElementById('admin-view');
          const adminBusTableBody = document.getElementById('admin-bus-table-body');
          const adminPassengerTableBody = document.getElementById('admin-passenger-table-body');
          const editModal = document.getElementById('editModal');
          // const editForm = document.getElementById('editForm'); // No longer needed
          const editFieldsDiv = document.getElementById('edit-fields');
          const modalTitle = document.getElementById('modal-title');
          const editItemIdInput = document.getElementById('edit-item-id');
          const editItemTypeInput = document.getElementById('edit-item-type');
          const tabDriver = document.getElementById('tab-driver');
          const tabAdmin = document.getElementById('tab-admin');
          const bulkPassengerListTextarea = document.getElementById('bulk-passenger-list');
          const bulkAddFeedbackDiv = document.getElementById('bulk-add-feedback');
          const bulkAddPanel = document.getElementById('bulk-add-panel');
          const toggleBulkAddBtn = document.getElementById('toggle-bulk-add-btn');
          const modalSaveButton = document.getElementById('modal-save-button');


          // --- Utility Functions ---
          function showLoading(element, message = "Loading...") {
              if (element) {
                   let colspan = 1;
                   if (element.id === 'admin-bus-table-body') colspan = 4;
                   if (element.tagName === 'TBODY') {
                        element.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-4 loading-indicator">${message}</td></tr>`;
                   } else {
                        element.innerHTML = `<p class="loading-indicator text-center p-4">${message}</p>`;
                   }
              }
          }
          function disableButton(button, text = "Processing...") {
              if (button) {
                  button.disabled = true;
                  button.textContent = text;
              }
          }
          function enableButton(button, originalText) {
               if (button) {
                  button.disabled = false;
                  button.textContent = originalText;
              }
          }

          // --- View Switching ---
          window.switchView = function(viewName) {
              bulkAddFeedbackDiv.innerHTML = '';
              bulkAddPanel.classList.add('hidden');
              toggleBulkAddBtn.textContent = 'Show Bulk Add';

              if (!driverViewDiv || !adminViewDiv || !tabDriver || !tabAdmin) {
                  console.error("Core view elements not found!");
                  return;
              }

              if (viewName === 'admin') {
                  driverViewDiv.classList.add('hidden');
                  adminViewDiv.classList.remove('hidden');
                  tabDriver.classList.remove('tab-active', 'text-indigo-600');
                  tabDriver.classList.add('text-gray-500', 'hover:text-gray-700');
                  tabAdmin.classList.add('tab-active', 'text-indigo-600');
                  tabAdmin.classList.remove('text-gray-500', 'hover:text-gray-700');
                  displayAdminBuses();
                  displayAdminPassengers();
              } else {
                  driverViewDiv.classList.remove('hidden');
                  adminViewDiv.classList.add('hidden');
                  tabAdmin.classList.remove('tab-active', 'text-indigo-600');
                  tabAdmin.classList.add('text-gray-500', 'hover:text-gray-700');
                  tabDriver.classList.add('tab-active', 'text-indigo-600');
                  tabDriver.classList.remove('text-gray-500', 'hover:text-gray-700');
                  // Always try to populate buses when switching to driver view
                  // This handles cases where data might have changed in admin view
                  populateBusSelector();
              }
          }

          // --- Toggle Bulk Add Panel Function ---
          window.toggleBulkAddPanel = function() {
              const isHidden = bulkAddPanel.classList.contains('hidden');
              if (isHidden) {
                  bulkAddPanel.classList.remove('hidden');
                  toggleBulkAddBtn.textContent = 'Hide Bulk Add';
              } else {
                  bulkAddPanel.classList.add('hidden');
                  toggleBulkAddBtn.textContent = 'Show Bulk Add';
                  bulkAddFeedbackDiv.innerHTML = '';
              }
          }

          // --- Driver View Functions ---
          async function populateBusSelector() {
              console.log("[Populate Buses] Starting...");
              if (!busSelect) { console.error("[Populate Buses] Error: busSelect element not found."); return; }

              // Don't use showLoading on parent, just update the select itself
              busSelect.innerHTML = '<option value="" disabled selected>Loading buses...</option>';
              busSelect.disabled = true;
              console.log("[Populate Buses] Dropdown disabled.");

              try {
                  const busCol = collection(db, "buses");
                  console.log("[Populate Buses] Fetching documents from 'buses' collection...");
                  const busSnapshot = await getDocs(busCol);
                  console.log(`[Populate Buses] Fetched ${busSnapshot.size} bus documents.`);

                  cachedBuses = busSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  console.log("[Populate Buses] Mapped buses:", JSON.stringify(cachedBuses));

                  busSelect.innerHTML = '<option value="" disabled selected>-- Select a Bus --</option>'; // Reset options

                  if (cachedBuses.length === 0) {
                     console.warn("[Populate Buses] No buses found or mapped. Displaying 'No buses available'.");
                     busSelect.innerHTML = '<option value="" disabled selected>No buses available</option>';
                  } else {
                     cachedBuses.forEach((bus, index) => {
                         const option = document.createElement('option');
                         option.value = bus.id;
                         option.textContent = bus.identifier || `Bus ID: ${bus.id.substring(0, 6)}...`;
                         busSelect.appendChild(option);
                     });
                     console.log("[Populate Buses] Finished appending options.");
                  }
                  // **DEBUG:** Log option count after appending
                  console.log("[Populate Buses] Number of options after loop:", busSelect.options.length);

              } catch (error) {
                  console.error("[Populate Buses] Error during fetch or processing: ", error);
                  busSelect.innerHTML = '<option value="" disabled selected>Error loading buses</option>';
                  alert(`Error loading buses. Check console. Error: ${error.message}`);
              } finally {
                  busSelect.disabled = false;
                   // **DEBUG:** Log computed styles and final disabled status
                  try { // Add try/catch around style access just in case busSelect is invalid
                    const styles = window.getComputedStyle(busSelect);
                    console.log(`[Populate Buses] Final computed styles: display=${styles.display}, visibility=${styles.visibility}, height=${styles.height}, width=${styles.width}`);
                  } catch (styleError) {
                    console.error("[Populate Buses] Error getting computed styles:", styleError);
                  }
                  console.log(`[Populate Buses] Finally block reached. Setting disabled = false. Current status: ${busSelect.disabled}`);
              }
              console.log("[Populate Buses] Function finished.");
          }


          function updateSummary(passengerList) {
              const total = passengerList.length;
              const checkedIn = passengerList.filter(p => p.status === 'checked-in').length;
              const pending = total - checkedIn;
              totalPassengersSpan.textContent = total;
              checkedInCountSpan.textContent = checkedIn;
              pendingCountSpan.textContent = pending;
          }

          async function displayPassengers(selectedBusDocId) {
              if (!selectedBusDocId) {
                  passengerListDiv.innerHTML = '<p class="text-gray-500 text-center">Select a bus to see the passenger list.</p>';
                  updateSummary([]);
                  return;
              }
              showLoading(passengerListDiv, "Loading passengers...");
              updateSummary([]);

              try {
                  const passengersCol = collection(db, "passengers");
                  const q = query(passengersCol, where("assignedBusId", "==", selectedBusDocId));
                  const passengerSnapshot = await getDocs(q);
                  const passengerList = passengerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  passengerListDiv.innerHTML = '';

                  if (passengerSnapshot.empty) {
                      passengerListDiv.innerHTML = '<p class="text-gray-500 text-center">No passengers assigned to this bus.</p>';
                  } else {
                      passengerList.forEach(passenger => {
                          const passengerDiv = document.createElement('div');
                          passengerDiv.dataset.docId = passenger.id;
                          passengerDiv.className = `passenger-item flex items-center justify-between p-3 border border-gray-200 rounded-md ${passenger.status === 'checked-in' ? 'checked-in' : 'bg-white'}`;

                          const passengerNameSpan = document.createElement('span');
                          passengerNameSpan.className = "text-gray-800 font-medium";
                          passengerNameSpan.textContent = passenger.name;

                          const actionButton = document.createElement('button');
                          actionButton.className = 'action-button px-3 py-1 text-xs font-medium text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50';
                          if (passenger.status === 'pending') {
                              actionButton.textContent = 'Check In';
                              actionButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                              actionButton.onclick = (event) => handleCheckIn(passenger.id, selectedBusDocId, event.target);
                          } else {
                              actionButton.textContent = 'Undo';
                              actionButton.classList.add('undo-button');
                              actionButton.onclick = (event) => handleUndoCheckIn(passenger.id, selectedBusDocId, event.target);
                          }

                          passengerDiv.appendChild(passengerNameSpan);
                          passengerDiv.appendChild(actionButton);
                          passengerListDiv.appendChild(passengerDiv);
                      });
                  }
                  updateSummary(passengerList);

              } catch (error) {
                  console.error(`[Display Passengers] Error loading passengers for bus ${selectedBusDocId}: `, error);
                  passengerListDiv.innerHTML = '<p class="text-red-500 text-center">Error loading passengers.</p>';
                  alert(`Error loading passengers. Check console. Error: ${error.message}`);
                  updateSummary([]);
              }
          }

          async function handleCheckIn(passengerDocId, currentBusDocId, buttonElement) {
              disableButton(buttonElement, "Checking...");
              try {
                  const passengerRef = doc(db, "passengers", passengerDocId);
                  await updateDoc(passengerRef, { status: "checked-in" });
                  await displayPassengers(currentBusDocId);
              } catch (error) {
                  console.error("Error checking in passenger: ", error);
                  alert("Error checking in passenger. Please try again.");
              }
          }

          async function handleUndoCheckIn(passengerDocId, currentBusDocId, buttonElement) {
              disableButton(buttonElement, "Undoing...");
              try {
                  const passengerRef = doc(db, "passengers", passengerDocId);
                  await updateDoc(passengerRef, { status: "pending" });
                  await displayPassengers(currentBusDocId);
              } catch (error) {
                  console.error("Error undoing check-in: ", error);
                  alert("Error undoing check-in. Please try again.");
              }
          }

          // --- Admin View Functions ---
          let currentSort = { column: 'name', direction: 'asc' };

          function sortPassengers(passengers, column, direction) {
              return [...passengers].sort((a, b) => {
                  let aValue = a[column];
                  let bValue = b[column];

                  // Special handling for bus identifier sorting
                  if (column === 'bus') {
                      aValue = a.assignedBusId;
                      bValue = b.assignedBusId;
                  }

                  // Handle null/undefined values
                  if (aValue === null || aValue === undefined) return direction === 'asc' ? 1 : -1;
                  if (bValue === null || bValue === undefined) return direction === 'asc' ? -1 : 1;

                  // Convert to string for comparison
                  aValue = String(aValue).toLowerCase();
                  bValue = String(bValue).toLowerCase();

                  if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                  if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                  return 0;
              });
          }

          function updateSortHeaders() {
              const headers = document.querySelectorAll('.sortable-header');
              headers.forEach(header => {
                  header.classList.remove('asc', 'desc');
                  if (header.dataset.sort === currentSort.column) {
                      header.classList.add(currentSort.direction);
                  }
              });
          }

          async function displayAdminBuses() {
              showLoading(adminBusTableBody, "Loading buses...");
              try {
                  const busCol = collection(db, "buses");
                  const busSnapshot = await getDocs(busCol);
                  const busList = busSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  // Get all passengers to count per bus
                  const passengerCol = collection(db, "passengers");
                  const passengerSnapshot = await getDocs(passengerCol);
                  const passengerStatsMap = new Map();
                  
                  passengerSnapshot.docs.forEach(doc => {
                      const passenger = doc.data();
                      if (passenger.assignedBusId) {
                          const stats = passengerStatsMap.get(passenger.assignedBusId) || { total: 0, checkedIn: 0, pending: 0 };
                          stats.total++;
                          if (passenger.status === 'checked-in') {
                              stats.checkedIn++;
                          } else {
                              stats.pending++;
                          }
                          passengerStatsMap.set(passenger.assignedBusId, stats);
                      }
                  });

                  adminBusTableBody.innerHTML = '';
                  if (busList.length === 0) {
                      adminBusTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-gray-500">No buses found.</td></tr>';
                  } else {
                      busList.forEach(bus => {
                          const row = adminBusTableBody.insertRow();
                          const stats = passengerStatsMap.get(bus.id) || { total: 0, checkedIn: 0, pending: 0 };
                          const capacity = bus.capacity || 0;
                          const capacityClass = stats.total > capacity ? 'text-red-600' : 'text-gray-500';
                          
                          row.innerHTML = `
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${bus.identifier || 'N/A'}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm ${capacityClass}">
                                  ${stats.total} / ${capacity}
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">
                                  ${stats.checkedIn}
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600">
                                  ${stats.pending}
                              </td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <button onclick="openEditModal('bus', '${bus.id}')" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                              </td>
                          `;
                      });
                  }
              } catch (error) {
                  console.error("Error loading admin buses: ", error);
                  adminBusTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Error loading buses.</td></tr>';
                  alert("Error loading buses for admin view. Please check console.");
              }
          }

          async function displayAdminPassengers() {
              showLoading(adminPassengerTableBody, "Loading passengers...");
              try {
                  const passengerCol = collection(db, "passengers");
                  const passengerSnapshot = await getDocs(passengerCol);
                  let passengerList = passengerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                  // Get all buses to map IDs to identifiers
                  const busCol = collection(db, "buses");
                  const busSnapshot = await getDocs(busCol);
                  const busMap = new Map();
                  busSnapshot.docs.forEach(doc => {
                      busMap.set(doc.id, doc.data().identifier || 'N/A');
                  });

                  // Add bus identifier to passenger data for sorting
                  passengerList = passengerList.map(passenger => ({
                      ...passenger,
                      bus: passenger.assignedBusId ? busMap.get(passenger.assignedBusId) || 'N/A' : 'N/A'
                  }));

                  // Sort the passenger list
                  passengerList = sortPassengers(passengerList, currentSort.column, currentSort.direction);

                  adminPassengerTableBody.innerHTML = '';
                  if (passengerList.length === 0) {
                      adminPassengerTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No passengers found.</td></tr>';
                  } else {
                      passengerList.forEach(passenger => {
                          const row = adminPassengerTableBody.insertRow();
                          row.innerHTML = `
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${passenger.name || 'N/A'}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${passenger.gender || 'N/A'}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${passenger.mobileNumber || 'N/A'}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${passenger.bus}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${passenger.status || 'N/A'}</td>
                              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                  <button onclick="openEditModal('passenger', '${passenger.id}')" class="text-indigo-600 hover:text-indigo-900">Edit</button>
                                  <button onclick="handleDeletePassenger('${passenger.id}')" class="text-red-600 hover:text-red-900 ml-4">Delete</button>
                              </td>
                          `;
                      });
                  }
                  updateSortHeaders();
              } catch (error) {
                  console.error("Error loading admin passengers: ", error);
                  adminPassengerTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500">Error loading passengers.</td></tr>';
                  alert("Error loading passengers for admin view. Please check console.");
              }
          }

          // --- Delete Passenger Function ---
          window.handleDeletePassenger = async function(passengerDocId) {
              if (confirm(`Are you sure you want to delete passenger data? This action cannot be undone.`)) {
                  console.log(`Attempting to delete passenger doc ID: ${passengerDocId}`);
                  try {
                      const passengerRef = doc(db, "passengers", passengerDocId);
                      await deleteDoc(passengerRef);
                      console.log(`Successfully deleted passenger doc ID ${passengerDocId} from Firestore.`);
                      await displayAdminPassengers();
                      const selectedBusId = busSelect.value;
                       if (selectedBusId) {
                           await displayPassengers(selectedBusId);
                       }
                  } catch (error) {
                      console.error(`Error deleting passenger ${passengerDocId}: `, error);
                      alert("Error deleting passenger. Please check console.");
                  }
              } else {
                   console.log(`Deletion cancelled for passenger doc ID ${passengerDocId}.`);
              }
          }


          // --- Modal Functions ---
          function createBusOptionsHtml(selectedBusId = null) {
              let busOptionsHtml = '<option value="">-- Unassigned --</option>';
              if (cachedBuses.length === 0) {
                  console.warn("Bus cache empty when creating options.");
              }
              cachedBuses.forEach(bus => {
                  const selected = (bus.id === selectedBusId) ? 'selected' : '';
                  busOptionsHtml += `<option value="${bus.id}" ${selected}>${bus.identifier || `Bus ID: ${bus.id.substring(0,6)}...`}</option>`;
              });
              return busOptionsHtml;
          }

          window.openAddBusModal = function() {
              modalTitle.textContent = `Add New Bus`;
              editItemIdInput.value = '';
              editItemTypeInput.value = 'bus';
              editFieldsDiv.innerHTML = `
                  <div><label for="edit-bus-identifier" class="block text-sm font-medium text-gray-700">Identifier/Route</label><input type="text" id="edit-bus-identifier" value="" placeholder="e.g., BUS-D20 - Route 7" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                  <div><label for="edit-bus-capacity" class="block text-sm font-medium text-gray-700">Capacity</label><input type="number" id="edit-bus-capacity" value="" placeholder="e.g., 55" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
              `;
              editModal.style.display = 'block';
          }

          window.openAddPassengerModal = async function() {
              modalTitle.textContent = `Add New Passenger`;
              editItemIdInput.value = '';
              editItemTypeInput.value = 'passenger';

              if (cachedBuses.length === 0) {
                  console.warn("Bus cache empty, fetching for add passenger modal.");
                  showLoading(editFieldsDiv);
                  editModal.style.display = 'block';
                  try {
                      await populateBusSelector();
                  } catch (error) {
                       editFieldsDiv.innerHTML = `<p class="text-red-500">Error loading buses for selection.</p>`;
                       return;
                  }
              }

              const busSelectHtml = `
                  <div>
                      <label for="edit-passenger-bus" class="block text-sm font-medium text-gray-700">Assigned Bus</label>
                      <select id="edit-passenger-bus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                          ${createBusOptionsHtml()} </select>
                  </div>`;

              editFieldsDiv.innerHTML = `
                  <div><label for="edit-passenger-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="edit-passenger-name" value="" placeholder="Passenger Name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                  <div>
                      <label for="edit-passenger-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                      <select id="edit-passenger-gender" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                          <option value="Female">Female</option>
                          <option value="Male" selected>Male</option> </select>
                  </div>
                  <div><label for="edit-passenger-mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label><input type="tel" id="edit-passenger-mobile" value="" placeholder="e.g., 555-0101" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                  ${busSelectHtml} <div><label for="edit-passenger-status" class="block text-sm font-medium text-gray-700">Status</label><select id="edit-passenger-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"><option value="pending" selected>Pending</option><option value="checked-in">Checked-in</option></select></div>
              `;
              if (editModal.style.display !== 'block') {
                 editModal.style.display = 'block';
              }
          }

          window.openEditModal = async function(itemType, docId) {
              showLoading(editFieldsDiv);
              editModal.style.display = 'block';
              editItemIdInput.value = docId;
              editItemTypeInput.value = itemType;

              try {
                  if (itemType === 'bus') {
                      const busRef = doc(db, "buses", docId);
                      const busSnap = await getDoc(busRef);
                      if (!busSnap.exists()) throw new Error("Bus document not found!");
                      const bus = busSnap.data();
                      modalTitle.textContent = `Edit Bus`;
                      editFieldsDiv.innerHTML = `
                          <div><label for="edit-bus-identifier" class="block text-sm font-medium text-gray-700">Identifier/Route</label><input type="text" id="edit-bus-identifier" value="${bus.identifier || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                          <div><label for="edit-bus-capacity" class="block text-sm font-medium text-gray-700">Capacity</label><input type="number" id="edit-bus-capacity" value="${bus.capacity || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                      `;
                  } else if (itemType === 'passenger') {
                      const passengerRef = doc(db, "passengers", docId);
                      const passengerSnap = await getDoc(passengerRef);
                       if (!passengerSnap.exists()) throw new Error("Passenger document not found!");
                      const passenger = passengerSnap.data();
                      modalTitle.textContent = `Edit Passenger`;

                      if (cachedBuses.length === 0) {
                          console.warn("Bus cache empty, fetching for edit passenger modal.");
                          await populateBusSelector();
                      }
                      const busSelectHtml = `
                          <div>
                              <label for="edit-passenger-bus" class="block text-sm font-medium text-gray-700">Assigned Bus</label>
                              <select id="edit-passenger-bus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                  ${createBusOptionsHtml(passenger.assignedBusId)} </select>
                          </div>`;

                      editFieldsDiv.innerHTML = `
                          <div><label for="edit-passenger-name" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="edit-passenger-name" value="${passenger.name || ''}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                          <div>
                              <label for="edit-passenger-gender" class="block text-sm font-medium text-gray-700">Gender</label>
                              <select id="edit-passenger-gender" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                  <option value="Female" ${passenger.gender === 'Female' ? 'selected' : ''}>Female</option>
                                  <option value="Male" ${passenger.gender === 'Male' ? 'selected' : ''}>Male</option>
                              </select>
                          </div>
                          <div><label for="edit-passenger-mobile" class="block text-sm font-medium text-gray-700">Mobile Number</label><input type="tel" id="edit-passenger-mobile" value="${passenger.mobileNumber || ''}" placeholder="e.g., 555-0101" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"></div>
                          ${busSelectHtml} <div><label for="edit-passenger-status" class="block text-sm font-medium text-gray-700">Status</label><select id="edit-passenger-status" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm"><option value="pending" ${passenger.status === 'pending' ? 'selected' : ''}>Pending</option><option value="checked-in" ${passenger.status === 'checked-in' ? 'selected' : ''}>Checked-in</option></select></div>
                      `;
                  }
              } catch (error) {
                  console.error("Error loading data for modal: ", error);
                  editFieldsDiv.innerHTML = `<p class="text-red-500">Error loading details: ${error.message}</p>`;
                  alert("Error loading details for editing. Please check console.");
              }
          }

          window.closeEditModal = function() {
              editModal.style.display = 'none';
          }

          // Handles Save Changes for BOTH Add and Edit
          async function handleSaveChanges() {
              // event.preventDefault(); // Removed

              disableButton(modalSaveButton, "Saving...");
              const originalButtonText = "Save Changes";

              const docId = editItemIdInput.value;
              const itemType = editItemTypeInput.value;
              const isAdding = !docId;
              let data = {};

              console.log(`[Save] Starting save. Mode: ${isAdding ? 'Add' : 'Edit'}, Type: ${itemType}, DocId: ${docId || 'N/A'}`);

              try {
                  if (itemType === 'bus') {
                      const identifierEl = document.getElementById('edit-bus-identifier');
                      const capacityEl = document.getElementById('edit-bus-capacity');
                      if (!identifierEl || !capacityEl) throw new Error("Bus form elements not found!");
                      data = {
                          identifier: identifierEl.value,
                          capacity: parseInt(capacityEl.value, 10) || 0
                      };
                      console.log("[Save] Bus data:", data);
                  } else if (itemType === 'passenger') {
                      const nameEl = document.getElementById('edit-passenger-name');
                      const genderEl = document.getElementById('edit-passenger-gender');
                      const mobileEl = document.getElementById('edit-passenger-mobile');
                      const busEl = document.getElementById('edit-passenger-bus');
                      const statusEl = document.getElementById('edit-passenger-status');
                      if (!nameEl || !genderEl || !mobileEl || !busEl || !statusEl) throw new Error("Passenger form elements not found!");
                      data = {
                          name: nameEl.value,
                          gender: genderEl.value,
                          mobileNumber: mobileEl.value || null,
                          assignedBusId: busEl.value || null,
                          status: statusEl.value
                      };
                       console.log("[Save] Passenger data:", data);
                  } else {
                       throw new Error(`Unknown item type: ${itemType}`);
                  }

                  if (isAdding) {
                      console.log(`[Save] Calling addDoc for ${itemType}...`);
                      const addedDocRef = await addDoc(collection(db, itemType === 'bus' ? "buses" : "passengers"), data);
                      console.log(`[Save] ${itemType} added successfully with ID: ${addedDocRef.id}.`);
                  } else {
                      console.log(`[Save] Calling updateDoc for ${itemType} ${docId}...`);
                      const itemRef = doc(db, itemType === 'bus' ? "buses" : "passengers", docId);
                      await updateDoc(itemRef, data);
                      console.log(`[Save] ${itemType} ${docId} updateDoc successful.`);
                  }

                  console.log("[Save] Refreshing UI...");
                  if (itemType === 'bus') {
                      await displayAdminBuses();
                      await populateBusSelector();
                  } else {
                      await displayAdminPassengers();
                      const selectedBusId = busSelect.value;
                      if (selectedBusId) {
                           await displayPassengers(selectedBusId);
                      }
                  }
                  closeEditModal();

              } catch (error) {
                  console.error(`[Save] Error saving ${itemType} ${docId || '(new)'}: `, error);
                  alert(`Error saving changes for ${itemType}. Please check the console for details. Error: ${error.message}`);
              } finally {
                  enableButton(modalSaveButton, originalButtonText);
                  console.log("[Save] Save operation finished (finally block).");
              }
          }


          // --- Bulk Add Passenger Function ---
          window.handleBulkAddPassengers = async function() {
              const importButton = document.getElementById('import-list-button');
              disableButton(importButton, "Importing...");
              bulkAddFeedbackDiv.innerHTML = '';

              const fileInput = document.getElementById('excel-file');
              const file = fileInput.files[0];
              
              if (!file) {
                  const errorMsg = document.createElement('div');
                  errorMsg.className = 'feedback-message feedback-error';
                  errorMsg.textContent = 'Please select an Excel file to import.';
                  bulkAddFeedbackDiv.appendChild(errorMsg);
                  enableButton(importButton, "Import Excel");
                  return;
              }

              try {
                  // Create a new Excel reader
                  const reader = new FileReader();
                  reader.onload = async function(e) {
                      const data = new Uint8Array(e.target.result);
                      const workbook = XLSX.read(data, { type: 'array' });
                      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                      // Skip header row
                      const rows = jsonData.slice(1);
                      let addedCount = 0;
                      let errorCount = 0;
                      let errors = [];
                      const batch = writeBatch(db);
                      let operationsInBatch = 0;
                      const MAX_BATCH_OPERATIONS = 499;

                      rows.forEach((row, index) => {
                          if (!row || row.length < 3) {
                              errors.push(`Row ${index + 2}: Incorrect format. Expected 3 columns.`);
                              errorCount++;
                              return;
                          }

                          const [name, gender, mobileNumber] = row.map(v => v ? v.toString().trim() : '');
                          
                          if (!name) {
                              errors.push(`Row ${index + 2}: Name is empty.`);
                              errorCount++;
                              return;
                          }

                          const newPassengerData = {
                              name,
                              gender: gender || 'N/A',
                              mobileNumber: mobileNumber || null,
                              status: 'pending',
                              assignedBusId: null // Will be updated later
                          };

                          const newPassengerRef = doc(collection(db, "passengers"));
                          batch.set(newPassengerRef, newPassengerData);
                          operationsInBatch++;
                          addedCount++;
                      });

                      if (operationsInBatch > 0 && errorCount === 0) {
                          try {
                              await batch.commit();
                              console.log(`Batch committed with ${addedCount} passengers.`);
                              fileInput.value = ''; // Clear file input
                              await displayAdminPassengers();
                              const selectedBusId = busSelect.value;
                              if (selectedBusId) await displayPassengers(selectedBusId);
                          } catch (error) {
                              console.error("Error committing batch: ", error);
                              errors.push(`DB Error: ${error.message}`);
                              errorCount += addedCount;
                              addedCount = 0;
                          }
                      } else if (operationsInBatch > 0 && errorCount > 0) {
                          errors.push("Import aborted due to errors.");
                      }

                      // Display feedback
                      if (addedCount > 0) {
                          const successMsg = document.createElement('div');
                          successMsg.className = 'feedback-message feedback-success';
                          successMsg.textContent = `Successfully imported ${addedCount} passengers.`;
                          bulkAddFeedbackDiv.appendChild(successMsg);
                      }
                      if (errorCount > 0) {
                          const errorMsg = document.createElement('div');
                          errorMsg.className = 'feedback-message feedback-error';
                          errorMsg.innerHTML = `Skipped/Failed ${errorCount} rows:<ul>${errors.map(e => `<li class="ml-4 text-xs">${e}</li>`).join('')}</ul>`;
                          bulkAddFeedbackDiv.appendChild(errorMsg);
                      }
                      if (addedCount === 0 && errorCount === 0 && rows.length > 0) {
                          const noDataMsg = document.createElement('div');
                          noDataMsg.className = 'feedback-message feedback-error';
                          noDataMsg.textContent = 'No valid passenger data found to import.';
                          bulkAddFeedbackDiv.appendChild(noDataMsg);
                      }

                      enableButton(importButton, "Import Excel");
                  };

                  reader.readAsArrayBuffer(file);
              } catch (error) {
                  console.error("Error processing Excel file: ", error);
                  const errorMsg = document.createElement('div');
                  errorMsg.className = 'feedback-message feedback-error';
                  errorMsg.textContent = `Error processing Excel file: ${error.message}`;
                  bulkAddFeedbackDiv.appendChild(errorMsg);
                  enableButton(importButton, "Import Excel");
              }
          }

          // --- Event Listeners ---
          busSelect.addEventListener('change', (event) => {
              const selectedBusDocId = event.target.value;
              if (selectedBusDocId) { displayPassengers(selectedBusDocId); }
              else { passengerListDiv.innerHTML = '<p class="text-gray-500 text-center">Select a bus to see the passenger list.</p>'; updateSummary([]); }
          });
          modalSaveButton.addEventListener('click', handleSaveChanges); // Listen to button click

          window.onclick = function(event) { if (event.target == editModal) { closeEditModal(); } }

          // --- Initial Load ---
          document.addEventListener('DOMContentLoaded', () => {
               console.log("DOM Loaded. Calling initial populateBusSelector.");
               populateBusSelector(); // Load buses needed for driver view initially
               // Driver view is visible by default
          });

          // Add event listeners for sorting
          document.addEventListener('DOMContentLoaded', () => {
              const sortableHeaders = document.querySelectorAll('.sortable-header');
              sortableHeaders.forEach(header => {
                  header.addEventListener('click', () => {
                      const column = header.dataset.sort;
                      if (currentSort.column === column) {
                          // Toggle direction if clicking the same column
                          currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                      } else {
                          // Set new column and default to ascending
                          currentSort.column = column;
                          currentSort.direction = 'asc';
                      }
                      displayAdminPassengers();
                  });
              });
          });

      } catch (error) {
          console.error("Firebase Initialization Failed: ", error);
          alert("FATAL ERROR: Firebase could not be initialized. Check console and Firebase configuration.");
      }

    </script>

</body>
</html>
